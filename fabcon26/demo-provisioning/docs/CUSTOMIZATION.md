# Customization Guide

This guide explains how to adapt this provisioning toolkit for your own Microsoft Fabric Data Engineering solution.

## Table of Contents

- [Understanding the Architecture](#understanding-the-architecture)
- [Customizing the Workspace](#customizing-the-workspace)
- [Replacing Item Templates](#replacing-item-templates)
- [Modifying Data Sources](#modifying-data-sources)
- [Adjusting the Provisioning Script](#adjusting-the-provisioning-script)
- [Configuring CI/CD](#configuring-cicd)
- [Adding New Item Types](#adding-new-item-types)
- [Environment-Specific Configuration](#environment-specific-configuration)

---

## Understanding the Architecture

The toolkit uses a **two-phase approach**:

1. **Terraform** creates the workspace and lakehouses (infrastructure)
2. **fabric-cli scripts** import items, set bindings, create shortcuts, and run pipelines

The bridge between them is `.terraform-outputs.env` — a file auto-generated by Terraform that the scripts read to get IDs.

```
terraform apply  →  .terraform-outputs.env  →  provision-items.sh
     ↓                      ↓                        ↓
  workspace ID        loaded by scripts       uses IDs to import items
  lakehouse IDs
```

## Customizing the Workspace

### Change Workspace Naming

Edit `terraform/terraform.tfvars`:

```hcl
workspace_prefix = "MyProject"    # Default: "DEWorkshop"
username         = "teamname"     # Your identifier
```

This creates a workspace named `MyProject_teamname`.

### Change Lakehouse Names

```hcl
bronze_lakehouse_name = "Raw_Data"       # Default: "Lakehouse_Bronze"
silver_lakehouse_name = "Curated_Data"   # Default: "Lakehouse_Silver"
```

> **Important**: If you change lakehouse names, also update `ado/parameter.yml` to match.

### Add More Lakehouses

Add to `terraform/main.tf`:

```hcl
resource "fabric_lakehouse" "gold" {
  display_name = "Lakehouse_Gold"
  workspace_id = fabric_workspace.dev.id
  description  = "Gold layer — aggregated business data"

  configuration = {
    enable_schemas = var.enable_lakehouse_schemas
  }

  depends_on = [fabric_lakehouse.silver]
}
```

Add the output to `terraform/outputs.tf` and the env var will appear in `.terraform-outputs.env`.

## Replacing Item Templates

Templates live in `templates/` and are populated by `./scripts/setup.sh`. To use your own:

### Option 1: Replace After Setup

```bash
# Run setup to get the structure
./scripts/setup.sh

# Replace specific items
rm -rf templates/MyLHCopyJob.CopyJob
cp -r /path/to/your/CopyJob templates/YourCopyJob.CopyJob
```

### Option 2: Export from an Existing Workspace

Use fabric-cli to export items from a workspace you've built manually:

```bash
# Export a single item
fab export /YourWorkspace.Workspace/YourNotebook.Notebook -o templates/YourNotebook.Notebook

# Export multiple items
for item in Notebook1 Notebook2 Pipeline1; do
  fab export "/YourWorkspace.Workspace/${item}.*" -o "templates/"
done
```

### Template Structure

Each item follows this structure:

```
ItemName.ItemType/
├── .platform           # Metadata (type, display name, logical ID)
└── <content-files>     # Item-specific definition files
```

The `.platform` file must have the correct `type` field:

```json
{
  "metadata": {
    "type": "Notebook",
    "displayName": "MyNotebook"
  },
  "config": {
    "version": "2.0",
    "logicalId": "00000000-0000-0000-0000-000000000000"
  }
}
```

## Modifying Data Sources

### Copy Jobs

Copy Jobs define where data comes from. Edit the `copyjob-content.json` inside each Copy Job template:

```json
{
  "properties": {
    "source": {
      "type": "Parquet",
      "connectionSettings": {
        "type": "AzureBlobStorage",
        "typeProperties": {
          "containerUri": "https://yourstorageaccount.blob.core.windows.net/yourcontainer"
        }
      }
    }
  }
}
```

### Placeholder GUIDs

The templates contain placeholder GUIDs that get replaced at provisioning time. These are defined in `scripts/provision-items.sh`:

```bash
# Copy Job template placeholders
readonly PH_COPYJOB_WORKSPACE_ID="8e0cc78d-1667-4e88-9523-a04c1d5dd187"
readonly PH_COPYJOB_LAKEHOUSE_ID="3ad63567-2849-4e5b-9cf2-eacd059e50a5"
```

If you use different templates, update these constants to match the GUIDs in YOUR template files.

## Adjusting the Provisioning Script

### Adding New Items

To add a new item to the provisioning flow, edit `scripts/provision-items.sh`:

1. Add the template to `templates/`
2. Add an import step:

```bash
# ─── Step N: Import Your New Item ─────────────────────────────────────
log_step N "Import YourItem"
fab_import_item "YourItem.ItemType" "ItemType"
log_success "YourItem imported"
```

3. If the item needs GUID replacement, add it before import:

```bash
fab_replace_in_template "YourItem.ItemType" "OLD_GUID" "${NEW_VALUE}"
```

### Changing Notebook Bindings

Notebook lakehouse bindings are set with `fab_bind_notebook`:

```bash
fab_bind_notebook "YourNotebook.Notebook" \
  "${LAKEHOUSE_ID}" \
  "${LAKEHOUSE_NAME}" \
  "${WORKSPACE_ID}"
```

### Adding Shortcuts

Use `fab_create_shortcut` (idempotent — safe to run multiple times):

```bash
fab_create_shortcut "target_table_name" "source_table_name" \
  "${TARGET_LAKEHOUSE_PATH}" "${SOURCE_LAKEHOUSE_PATH}"
```

### Skipping Steps

The script supports `--skip-data` to skip pipeline execution:

```bash
./scripts/provision-items.sh --skip-data
```

You can add similar flags for other optional steps.

## Configuring CI/CD

### Update Pipeline Variables

In `ado/Deploy-To-Fabric.yml`, update the variables section:

```yaml
variables:
  azureServiceConnection: "YourServiceConnection"
  devWorkspaceName: "YourProject_youruser"
  testWorkspaceName: "YourProject_youruser_Test"
  prodWorkspaceName: "YourProject_youruser_Prod"
  gitFolder: "YourGitFolder"
```

### Update Remapping Rules

In `ado/parameter.yml`, update the `find_value` fields with your Dev workspace's actual IDs:

```yaml
find_replace:
  - find_value: "your-bronze-lakehouse-id-here"
    replace_value:
      _ALL_: "$items.Lakehouse.Lakehouse_Bronze.id"
    item_type: "Notebook"
```

You can retrieve your IDs with:

```bash
fab get /YourWorkspace.Workspace/Lakehouse_Bronze.Lakehouse -q id
fab get /YourWorkspace.Workspace/Lakehouse_Silver.Lakehouse -q id
fab get /YourWorkspace.Workspace -q id
```

### Add Custom Remapping

For items with environment-specific values (like connection strings), add new entries:

```yaml
  - find_value: "dev-specific-connection-string"
    replace_value:
      test: "test-connection-string"
      prod: "prod-connection-string"
    item_type: "YourItemType"
```

## Adding New Item Types

The `fab-helpers.sh` library provides reusable functions. For new item types:

1. **Simple import**: Use `fab_import_item "ItemName.Type" "Type"`
2. **With GUID replacement**: Add `fab_replace_in_template` calls before import
3. **With JSON manipulation**: Use `fab_replace_json_value` for structured edits
4. **New wrapper function**: Add to `scripts/lib/fab-helpers.sh` following existing patterns

## Environment-Specific Configuration

### Terraform Workspaces

For managing multiple environments with Terraform:

```bash
# Create separate state per environment
terraform workspace new test
terraform workspace new prod

# Apply with environment-specific vars
terraform apply -var-file="terraform.tfvars" -var="workspace_prefix=DEWorkshop_Test"
```

### Variable Libraries

For Fabric Variable Libraries that change values per environment:

```bash
# Create the Variable Library
./scripts/create-variable-library.sh

# Then configure value sets in the Fabric UI:
#   - Default (Dev): workspace_id=<dev-ws-id>
#   - Test: workspace_id=<test-ws-id>
#   - Production: workspace_id=<prod-ws-id>
```

### SPN Authentication

For CI/CD or headless environments:

```bash
# Set SPN credentials
export FAB_CLIENT_ID="<client-id>"
export FAB_CLIENT_SECRET="<client-secret>"
export FAB_TENANT_ID="<tenant-id>"

# Add SPN to workspace (in terraform.tfvars)
spn_object_id = "<spn-object-id>"
```

---

## Tips for AI Agents

If you're using this toolkit with an AI coding agent (like GitHub Copilot):

1. **Start with the README** to understand the full picture
2. **Read `provision-items.sh`** to understand the provisioning flow
3. **Check `fab-helpers.sh`** for available wrapper functions
4. **Use `--dry-run`** to preview changes: `./scripts/provision-items.sh --dry-run`
5. **The Makefile** provides the simplest entry point: `make help`

The scripts are designed to be self-documenting — each function has usage comments, and the main scripts have step-by-step logging.
